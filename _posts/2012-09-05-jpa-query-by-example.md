---
layout: english
title: JPA2 Query By Example
comments: true
---
## Query by example with JPA 2

In this post, we present our work on providing Query By Example for JPA 2 in projects generated by SpringFuse.

The code uses JPA 2 standard only, it does not rely on any JPA implementation.

__More Resources__

* <a href="https://www.facebook.com/video/video.php?v=524162864265905&notif_t=video_processed">Watch a demo of the generated application</a>
* <a href="https://github.com/jaxio/generated-projects">Browse the code on GitHub</a>
* <a href="/#gen">Generate a project yourself</a> 
 
### What is Query By Example?

The idea is to use an entity as a parameter holder when doing query on an entity.
For example, assuming we have an `Account` entity with a `lastname` property. Here is how to do a simple query by example:

{% highlight java %}
Account account = new Account();
account.setLastname("agger"); // will apply LIKE %agger%
	
List<Account> result = accountRepository.find(account);
{% endhighlight %}

This codes leads in fine to following SQL query:

{% highlight sql %}
select
    account0_.id as id3_,
    account0_.address_id as address2_3_,
    account0_.BIRTH_DATE as BIRTH3_3_,
    account0_.civility as civility3_,
    account0_.description as descript5_3_,
    account0_.email as email3_,
    account0_.FIRST_NAME as FIRST7_3_,
    account0_.is_enabled as is8_3_,
    account0_.LAST_NAME as LAST9_3_,
    account0_."PASSWORD" as PASSWORD10_3_,
    account0_.login as login3_,
    account0_.version as version3_ 
from
    Account account0_ 
where
    lower(account0_.LAST_NAME)=? limit ?
{% endhighlight %}

### Mixing Query by Example and Range Query.

Now, let's imagine that you also want to restrict the query above to all accounts having their date of birth between 1940 and 1945 included.
Of course, the entity does not have the appropriate property (from & to). 
For this reason, we introduce some additional `RangeDate` parameters. Here is an example:

{% highlight java %}
Calendar from = Calendar.getInstance();
from.set(1940, 0, 1);

Calendar to = Calendar.getInstance();
to.set(1945, 11, 31);
Account account = new Account();

// like
account.setLastName("Jagger");        

// between from and to
RangeDate<Account> birthDateRange = new RangeDate<Account>(Account_.birthDate);
birthDateRange.setFrom(from.getTime());
birthDateRange.setTo(to.getTime());

SearchParameters searchParameters = new SearchParameters();
searchParameters.addRange(birthDateRange);

List<Account> result = accountRepository.find(account, searchParameters);
{% endhighlight %}

Note that you can add ranges of any type: Integer, Long, LocalDate (joda time), BigDecimal, etc...

This codes leads in fine to following SQL query:

{% highlight sql %}
select
    account0_.id as id2_,
    account0_.address_id as address2_2_,
    account0_.BIRTH_DATE as BIRTH3_2_,
    account0_.civility as civility2_,
    account0_.description as descript5_2_,
    account0_.email as email2_,
    account0_.FIRST_NAME as FIRST7_2_,
    account0_.is_enabled as is8_2_,
    account0_.LAST_NAME as LAST9_2_,
    account0_."PASSWORD" as PASSWORD10_2_,
    account0_.login as login2_,
    account0_.version as version2_ 
from
    Account account0_ 
where
    (
        account0_.BIRTH_DATE between ? and ?
    ) 
    and lower(account0_.LAST_NAME)=? limit ?
{% endhighlight %}

### Query all string properties in a OR clause

You can also query all entities having at least one of their String property matching a given value, here is how: 

{% highlight java %}    
List<Account> result = accountRepository.find("foo");
{% endhighlight %}

Here is the resulting SQL query:

{% highlight sql %}    
select
    account0_.id as id1_,
    account0_.address_id as address2_1_,
    account0_.BIRTH_DATE as BIRTH3_1_,
    account0_.civility as civility1_,
    account0_.description as descript5_1_,
    account0_.email as email1_,
    account0_.FIRST_NAME as FIRST7_1_,
    account0_.is_enabled as is8_1_,
    account0_.LAST_NAME as LAST9_1_,
    account0_."PASSWORD" as PASSWORD10_1_,
    account0_.login as login1_,
    account0_.version as version1_ 
from
    Account account0_ 
where
    lower(account0_."PASSWORD") like ? 
    or lower(account0_.email) like ? 
    or lower(account0_.id) like ? 
    or lower(account0_.FIRST_NAME) like ? 
    or lower(account0_.LAST_NAME) like ? 
    or lower(account0_.description) like ? 
    or lower(account0_.login) like ? limit ?
{% endhighlight %}

### Pagination

Pagination parameters are set on the `SearchParameters`, as in the example below:

{% highlight java %}    
Account account = new Account();
account.setLastName("agger");

SearchParameters searchParameters = new SearchParameters();
searchParameters.setFirstResult(10); // the 11th element
searchParameters.setMaxResults(25); // page size

List<Account> result = accountRepository.find(account, searchParameters);
{% endhighlight %}

We now have an `offset` in the sql query:

{% highlight sql %}    
select
    account0_.id as id5_,
    account0_.address_id as address2_5_,
    account0_.BIRTH_DATE as BIRTH3_5_,
    account0_.civility as civility5_,
    account0_.description as descript5_5_,
    account0_.email as email5_,
    account0_.FIRST_NAME as FIRST7_5_,
    account0_.is_enabled as is8_5_,
    account0_.LAST_NAME as LAST9_5_,
    account0_."PASSWORD" as PASSWORD10_5_,
    account0_.login as login5_,
    account0_.version as version5_ 
from
    Account account0_ 
where
    lower(account0_.LAST_NAME)=? limit ? offset ?
{% endhighlight %}


### GenericDao Implementation

<a href="https://github.com/jaxio/generated-projects/">The full implementation is available on github</a> or in any generated project.

Here are few excepts

find method in GenericDao

{% highlight java %}    
public List<E> find(E entity, SearchParameters sp) {
    if (sp.hasNamedQuery()) {
        return (List<E>) getNamedQueryUtil().findByNamedQuery(sp);
    }

    CriteriaBuilder builder = entityManager.getCriteriaBuilder();
    CriteriaQuery<E> criteriaQuery = builder.createQuery(type);
    Root<E> root = criteriaQuery.from(type);

    // predicate
    Predicate predicate = getPredicate(root, criteriaQuery, builder, entity, sp);
    if (predicate != null) {
        criteriaQuery = criteriaQuery.where(predicate);
    }

    // order by
    criteriaQuery.orderBy(sp.getJpaOrders(root, builder));

    TypedQuery<E> typedQuery = entityManager.createQuery(criteriaQuery);

    // cache
    setCacheHints(typedQuery, sp);

    // pagination
    typedQuery.setFirstResult(sp.getFirstResult());
    typedQuery.setMaxResults(sp.getMaxResults());

    // execution
    List<E> entities = typedQuery.getResultList();
    if (log.isDebugEnabled()) {
        log.debug("Returned " + entities.size() + " elements");
    }

    return entities;
}
{% endhighlight %}    

This method is responsible for constructing the query and executing it.
It invokes the `getPredicate` method which construct a single `Predicate` out of the passed example and search parameters.
Here it is:

{% highlight java %}    
protected <R> Predicate getPredicate(Root<E> root, CriteriaQuery<R> query, CriteriaBuilder builder, E entity, SearchParameters sp) {
    List<Predicate> predicates = newArrayList();

    // search by range
    Predicate rangePredicate = ByRangeUtil.byRanges(root, query, builder, sp.getRanges(), type);
    if (rangePredicate != null) {
        predicates.add(rangePredicate);
    }

    // search by example
    Predicate examplePredicate = getByExamplePredicate(root, entity, sp, builder);
    if (examplePredicate != null) {
        predicates.add(examplePredicate);
    }

    // composite pk
    Predicate comppositePkPredicate = getByCompositePkPredicate(root, entity, sp, builder);
    if (comppositePkPredicate != null) {
        predicates.add(comppositePkPredicate);
    }

    // search by pattern
    Predicate patternPredicate = byPatternUtil.byPattern(root, query, builder, sp, type);
    if (patternPredicate != null) {
        predicates.add(patternPredicate);
    }

    return JpaUtil.andPredicate(predicates, builder);
}

protected Predicate getByExamplePredicate(Root<E> root, E entity, SearchParameters sp, CriteriaBuilder builder) {
    return byExampleUtil.byExampleOnEntity(root, entity, sp, builder);
}
{% endhighlight %}    

Here is the `ByRangeUtil.byRanges` method:

{% highlight java %}    
public static <E> Predicate byRanges(Root<E> root, CriteriaQuery<?> query, CriteriaBuilder builder, final List<Range<?, ?>> ranges, final Class<E> type) {

    List<Predicate> predicates = newArrayList();
    for (Range<?, ?> r : ranges) {
        @SuppressWarnings("unchecked")
        Range<E, ?> range = (Range<E, ?>) r;
        if (range.isSet()) {
            Predicate rangePredicate = buildRangePredicate(range, root, builder);

            if (rangePredicate != null) {
                if (!range.isIncludeNullSet() || range.getIncludeNull() == FALSE) {
                    predicates.add(rangePredicate);
                } else {
                    predicates.add(builder.or(rangePredicate, builder.isNull(root.get(range.getField()))));
                }
            }

            // no range at all, let's take the opportunity to keep only null...
            if (TRUE == range.getIncludeNull()) {
                predicates.add(builder.isNull(root.get(range.getField())));
            } else if (FALSE == range.getIncludeNull()) {
                predicates.add(builder.isNotNull(root.get(range.getField())));
            }
        }
    }

    return JpaUtil.andPredicate(predicates, builder);

}

private static <D extends Comparable<? super D>, E> Predicate buildRangePredicate(Range<E, D> range, Root<E> root, CriteriaBuilder builder) {
    if (range.isBetween()) {
        return builder.between(root.get(range.getField()), range.getFrom(), range.getTo());
    } else if (range.isFromSet()) {
        return builder.greaterThanOrEqualTo(root.get(range.getField()), range.getFrom());
    } else if (range.isToSet()) {
        return builder.lessThanOrEqualTo(root.get(range.getField()), range.getTo());
    }
    return null;
}
{% endhighlight %}    


And finally, the most complex part, the core of Query By Example, the `ByExampleUtil` helper class which construct the example Predicate.

{% highlight java %}
/*
 * (c) Copyright 2005-2012 JAXIO, www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to use Celerio within your company? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Template pack-backend-jpa:src/main/java/project/dao/support/ByExampleUtil.p.vm.java
 */
package com.jaxio.demo.dao.support;

import static com.google.common.collect.Lists.newArrayList;
import static javax.persistence.metamodel.Attribute.PersistentAttributeType.EMBEDDED;
import static javax.persistence.metamodel.Attribute.PersistentAttributeType.MANY_TO_ONE;
import static javax.persistence.metamodel.Attribute.PersistentAttributeType.ONE_TO_ONE;
import static org.apache.commons.lang.StringUtils.isNotEmpty;

import java.lang.reflect.Method;
import java.util.Collection;
import java.util.List;

import javax.inject.Named;
import javax.inject.Singleton;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.Path;
import javax.persistence.criteria.Predicate;
import javax.persistence.metamodel.Attribute;
import javax.persistence.metamodel.ManagedType;
import javax.persistence.metamodel.SingularAttribute;

import org.springframework.util.ReflectionUtils;

import com.google.common.base.Throwables;

/**
 * Helper to create find by example query.
 */
@Named
@Singleton
public class ByExampleUtil {

    @PersistenceContext
    private EntityManager em;

    public <T> Predicate byExampleOnEntity(Path<T> entityPath, final T entityValue, SearchParameters sp, CriteriaBuilder builder) {
        if (entityValue == null) {
            return null;
        }

        Class<T> type = entityPath.getModel().getBindableJavaType();
        ManagedType<T> mt = em.getMetamodel().entity(type);

        List<Predicate> predicates = newArrayList();
        byExample(mt, entityPath, entityValue, sp, builder, predicates);
        return JpaUtil.andPredicate(predicates, builder);
    }

    public <E> Predicate byExampleOnEmbeddable(Path<E> embeddablePath, final E embeddableValue, SearchParameters sp, CriteriaBuilder builder) {
        if (embeddableValue == null) {
            return null;
        }

        Class<E> type = embeddablePath.getModel().getBindableJavaType();
        ManagedType<E> mt = em.getMetamodel().embeddable(type); // note: calling .managedType() does not work

        List<Predicate> predicates = newArrayList();
        byExample(mt, embeddablePath, embeddableValue, sp, builder, predicates);
        return JpaUtil.andPredicate(predicates, builder);
    }

    private <T> void byExample(ManagedType<T> mt, Path<T> mtPath, final T mtValue, SearchParameters sp, CriteriaBuilder builder, List<Predicate> predicates) {
        for (SingularAttribute<? super T, ?> attr : mt.getSingularAttributes()) {
            if (attr.getPersistentAttributeType() == MANY_TO_ONE //
                    || attr.getPersistentAttributeType() == ONE_TO_ONE //
                    || attr.getPersistentAttributeType() == EMBEDDED) {
                continue;
            }

            Object attrValue = getValue(mtValue, attr);
            if (attrValue != null) {
                if (attr.getJavaType() == String.class) {
                    if (isNotEmpty((String) attrValue)) {
                        predicates.add(JpaUtil.stringPredicate(mtPath.get(stringAttribute(mt, attr)), attrValue, sp, builder));
                    }
                } else {
                    predicates.add(builder.equal(mtPath.get(attribute(mt, attr)), attrValue));
                }
            }
        }
    }

    /**
     * Helper method to a predicate out of the passed many-to-one or one-to-one association.
     * <p>
     * Note 1: If the fkpValue is present, there no need to add a predicate as it is already processed by byExample facility.
     * <p>
     * Note 2: By convention, if the passed fkeValue is not null and has no property set, we assume that you want a not null predicate on the fkePath.
     * 
     * @param fkpPath
     *            the raw fk path.
     * @param fkpValue
     *            the raw fk column value (it is annotated with Column), not used for inverse one-to-one
     * @param fkePath
     *            the path of the property carrying the x-to-one association (it is annotated with ManyToOne or OneToOne)
     * @param fkeValue
     *            the association value
     * @param builder
     *            criteria builder
     */

    public <FKP, FKE> void predicatesForToOneAssociation(Path<FKP> fkpPath, FKP fkpValue, Path<FKE> fkePath, FKE fkeValue, SearchParameters sp,
            CriteriaBuilder builder, List<Predicate> predicates) {
        if (fkeValue != null && fkpValue == null) {
            predicates.add(builder.and(builder.isNotNull(fkpPath), byExampleOnEntity(fkePath, fkeValue, sp, builder)));
        }
    }

    /**
     * Helper method to create a predicate out of the passed one-to-many or many-to-many association.
     * 
     * @param joinPath
     *            the join path of the property carrying the one-to-many or many-to-many association (it is annotated with OneToMany or ManyToMany)
     * @param cValue
     *            the association value
     * @param builder
     *            criteria builder
     */
    public <E> void predicatesForToManyAssociation(Path<E> joinPath, Collection<E> cValue, SearchParameters sp, CriteriaBuilder builder,
            List<Predicate> predicates) {
        if (cValue == null || cValue.isEmpty()) {
            return;
        }

        List<Predicate> examples = newArrayList();

        for (E item : cValue) {
            examples.add(byExampleOnEntity(joinPath, item, sp, builder));
        }

        predicates.add(builder.or(examples.toArray(new Predicate[predicates.size()])));
    }

    private <T> Object getValue(T example, Attribute<? super T, ?> attr) {
        try {
            return ReflectionUtils.invokeMethod((Method) attr.getJavaMember(), example);
        } catch (Exception e) {
            throw Throwables.propagate(e);
        }
    }

    private <T, A> SingularAttribute<? super T, A> attribute(ManagedType<? super T> mt, Attribute<? super T, A> attr) {
        return mt.getSingularAttribute(attr.getName(), attr.getJavaType());
    }

    private <T> SingularAttribute<? super T, String> stringAttribute(ManagedType<? super T> mt, Attribute<? super T, ?> attr) {
        return mt.getSingularAttribute(attr.getName(), String.class);
    }
}
{% endhighlight %}    



Enjoy!

The SpringFuse/Jaxio team.